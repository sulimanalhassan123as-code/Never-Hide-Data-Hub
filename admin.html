<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Never Hide Data Hub - Admin Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #e3f2fd; color: #333; margin: 0; padding: 0; }
        .navbar { background-color: #0d47a1; color: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3); position: sticky; top: 0; z-index: 100; }
        .navbar h1 { margin: 0; font-size: 18px; color: #90caf9; letter-spacing: 1px; text-transform: uppercase; }
        .logout-btn { background-color: #d32f2f; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .container { max-width: 800px; margin: 30px auto; padding: 30px; background: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .header-text { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        .ticket-card { background: #fff; padding: 15px; margin-bottom: 20px; border-left: 5px solid #0d47a1; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e0e0e0; }
        .product-card { background: #fff; padding: 15px; margin-bottom: 15px; border-left: 5px solid #ff9800; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .admin-controls { display: flex; gap: 8px; margin-top: 15px; align-items: center; flex-wrap: wrap; width: 100%; }
        select, input[type="text"], input[type="url"] { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; box-sizing: border-box; }
        input[type="text"], input[type="url"] { flex-grow: 1; min-width: 200px; }
        .update-btn { background-color: #1976d2; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .edit-btn { background-color: #0288d1; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .add-btn { background-color: #ff9800; color: white; border: none; padding: 12px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 15px; font-size: 16px; transition: 0.3s; }
        .delete-btn { background-color: #d32f2f; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        
        .image-upload-box { background: #fff; padding: 20px; border: 2px dashed #ff9800; border-radius: 8px; text-align: center; grid-column: span 2; }
        .custom-file-btn { color: white; padding: 10px 20px; border-radius: 30px; cursor: pointer; font-weight: bold; display: inline-block; font-size: 14px; margin: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        input[type="file"] { display: none; }
        .url-divider { margin: 15px 0; color: #888; font-weight: bold; font-size: 12px; text-transform: uppercase; }
        
        @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } .image-upload-box { grid-column: span 1; } }
    </style>
</head>
<body>

<div class="navbar">
    <h1>Data Hub - BOSS DASHBOARD</h1>
    <button class="logout-btn" onclick="logOut()">Sign Out</button>
</div>

<div class="container" style="border-top: 5px solid #ff9800;">
    <div class="header-text">
        <h2 style="color: #e65100; margin-top: 0;">üì¶ Storefront Inventory</h2>
        <p style="color: #666; font-size: 14px; margin-bottom: 0;">Add new bundles or edit existing ones.</p>
    </div>

    <div id="productFormArea" style="background: #fff8e1; padding: 20px; border-radius: 8px; border: 1px solid #ffecb3; margin-bottom: 30px;">
        <h3 id="formTitle" style="margin-top: 0; color: #ff8f00;">Add New Product</h3>
        <div class="form-grid">
            <input type="text" id="newProdName" placeholder="Product Name (e.g. MTN 10GB)">
            <input type="text" id="newProdPrice" placeholder="Price (e.g. 100 GHS)">
            <input type="text" id="newProdDesc" placeholder="Description or Affiliate Link">
            <select id="newProdCat">
                <option value="mtn">MTN</option>
                <option value="telecel">Telecel</option>
                <option value="airteltigo">AirtelTigo</option>
                <option value="ecg">ECG Bill</option>
                <option value="ad">Physical Product / Ad</option>
            </select>
            
            <div class="image-upload-box">
                <p style="margin-top: 0; font-weight: bold; color: #e65100; margin-bottom: 10px;">Product Image (Optional)</p>
                
                <div style="display: flex; justify-content: center; flex-wrap: wrap;">
                    <label for="cameraInput" class="custom-file-btn" style="background-color: #d32f2f;">üì∏ Take Photo</label>
                    <label for="galleryInput" class="custom-file-btn" style="background-color: #1976d2;">üñºÔ∏è Pick from Photos</label>
                </div>

                <input type="file" id="cameraInput" accept="image/*" capture="environment">
                <input type="file" id="galleryInput" accept="image/jpeg, image/png, image/webp">
                <p id="fileNameDisplay" style="font-size: 13px; color: #666; margin: 10px 0 0 0;">No file selected</p>

                <div class="url-divider">--- OR ---</div>
                
                <input type="url" id="newProdImageUrl" placeholder="Paste Image Link (https://...)" style="width: 100%; max-width: 400px; text-align: center;">
                
                <img id="preview" style="display: none; width: 200px; margin: 15px auto 0 auto; border-radius: 8px; border: 2px solid #ccc;">
            </div>
        </div>
        <button class="add-btn" id="uploadBtn" onclick="saveProduct()">Publish to Storefront</button>
        <button class="add-btn" id="cancelEditBtn" style="background-color: #666; display: none;" onclick="cancelEdit()">Cancel Edit</button>
    </div>

    <h3 style="color: #333;">Live Products</h3>
    <div id="allProductsContainer">
        <p style="color: #888; font-style: italic;">Loading inventory...</p>
    </div>
</div>

<div class="container">
    <div class="header-text">
        <h2>üõ†Ô∏è Master Support & Order Queue</h2>
    </div>
    <div id="allTicketsContainer">
        <p style="color: #888; font-style: italic;">Loading master database...</p>
    </div>
</div>

<script>
    const supabaseUrl = 'https://obyemhakouoipngwldsg.supabase.co';
    const supabaseKey = 'sb_publishable_oB_5NVgxwkwUucCECTzb2Q_1K0VqmyT';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
    const ADMIN_EMAIL = "ghanacyber2@gmail.com"; 

    let liveProductsArray = [];
    let editingProductId = null;
    let selectedImageFile = null;

    const display = document.getElementById("fileNameDisplay");
    const previewImg = document.getElementById("preview");
    const urlInput = document.getElementById("newProdImageUrl");

    // Handle File Pickers
    function handleImageSelection(event) {
        const file = event.target.files[0];
        if (!file) return;

        selectedImageFile = file; 
        urlInput.value = ""; // Clear the URL box if they pick a file
        display.innerHTML = `<strong style="color: #2e7d32;">‚úÖ File Selected: ${file.name}</strong>`;

        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            previewImg.style.display = "block";
        };
        reader.readAsDataURL(file);
    }

    document.getElementById("cameraInput").addEventListener("change", handleImageSelection);
    document.getElementById("galleryInput").addEventListener("change", handleImageSelection);

    // Handle URL Paste (Live Preview)
    urlInput.addEventListener("input", function() {
        const url = urlInput.value.trim();
        if (url) {
            selectedImageFile = null; // Clear any picked file
            display.innerText = "Using Image Link";
            previewImg.src = url;
            previewImg.style.display = "block";
        } else {
            display.innerText = "No file selected";
            previewImg.style.display = "none";
        }
    });

    async function checkSecurity() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session || session.user.email !== ADMIN_EMAIL) { window.location.replace('index.html'); return; }
        fetchProducts();
        fetchAllTickets();
    }

    async function fetchProducts() {
        const container = document.getElementById('allProductsContainer');
        const { data, error } = await supabaseClient.from('products').select('*').order('id', { ascending: false });
        if (error || !data) { container.innerHTML = '<p style="color: red;">Error loading inventory.</p>'; return; }
        if (data.length === 0) { container.innerHTML = '<p style="color: #888;">No products yet.</p>'; return; }

        liveProductsArray = data; 
        let html = '';
        
        data.forEach(prod => {
            let imgPreview = prod.image_url ? `<img src="${prod.image_url}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #ccc;">` : `<div style="width: 50px; height: 50px; background: #eee; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #999;">No Img</div>`;
            html += `
                <div class="product-card" id="product-row-${prod.id}">
                    <div style="display: flex; gap: 15px; align-items: center; flex-grow: 1;">
                        ${imgPreview}
                        <div>
                            <strong>${prod.name}</strong> - <span style="color: #2e7d32; font-weight: bold;">${prod.price}</span><br>
                            <span style="font-size: 12px; color: #666; text-transform: uppercase;">Category: ${prod.category}</span>
                        </div>
                    </div>
                    <div class="admin-controls" style="width: auto; margin-top: 0;">
                        <select id="prod-status-${prod.id}">
                            <option value="Available" ${prod.status === 'Available' ? 'selected' : ''}>üü¢ Available</option>
                            <option value="Coming Soon" ${prod.status === 'Coming Soon' ? 'selected' : ''}>üü° Coming Soon</option>
                            <option value="Out of Stock" ${prod.status === 'Out of Stock' ? 'selected' : ''}>üî¥ Out of Stock</option>
                        </select>
                        <button class="update-btn" onclick="updateProdStatus('${prod.id}')">Set Status</button>
                        <button class="edit-btn" onclick="loadEditForm('${prod.id}')">‚úèÔ∏è Edit</button>
                        <button class="delete-btn" onclick="deleteProduct('${prod.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function loadEditForm(rawId) {
        const targetId = /^\d+$/.test(rawId) ? parseInt(rawId) : rawId;
        const prod = liveProductsArray.find(p => p.id === targetId);
        if (!prod) return;

        editingProductId = targetId;
        selectedImageFile = null; // Clear file selection
        
        document.getElementById('newProdName').value = prod.name;
        document.getElementById('newProdPrice').value = prod.price;
        document.getElementById('newProdDesc').value = prod.description || "";
        document.getElementById('newProdCat').value = prod.category;
        
        // If it already has an image, put it in the URL box and show preview
        if (prod.image_url) {
            urlInput.value = prod.image_url;
            previewImg.src = prod.image_url;
            previewImg.style.display = "block";
            display.innerText = "Existing Image Loaded";
        } else {
            urlInput.value = "";
            previewImg.style.display = "none";
            display.innerText = "No file selected";
        }
        
        document.getElementById('formTitle').innerText = "‚úèÔ∏è Edit Product Details";
        document.getElementById('formTitle').style.color = "#0288d1";
        const btn = document.getElementById('uploadBtn');
        btn.innerText = "üíæ Save Changes";
        btn.style.backgroundColor = "#0288d1";
        document.getElementById('cancelEditBtn').style.display = "block";
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function cancelEdit() {
        editingProductId = null;
        selectedImageFile = null;
        document.getElementById('newProdName').value = '';
        document.getElementById('newProdPrice').value = '';
        document.getElementById('newProdDesc').value = '';
        document.getElementById('cameraInput').value = '';
        document.getElementById('galleryInput').value = '';
        urlInput.value = '';
        display.innerText = 'No file selected';
        previewImg.style.display = 'none';
        
        document.getElementById('formTitle').innerText = "Add New Product";
        document.getElementById('formTitle').style.color = "#ff8f00";
        const btn = document.getElementById('uploadBtn');
        btn.innerText = "Publish to Storefront";
        btn.style.backgroundColor = "#ff9800";
        document.getElementById('cancelEditBtn').style.display = "none";
    }

    async function saveProduct() {
        const name = document.getElementById('newProdName').value;
        const price = document.getElementById('newProdPrice').value;
        const desc = document.getElementById('newProdDesc').value;
        const cat = document.getElementById('newProdCat').value;
        
        if(!name || !price) { alert("Name and Price are required!"); return; }

        const btn = document.getElementById('uploadBtn');
        btn.innerText = "Processing..."; btn.disabled = true;

        // Start with whatever is in the URL box
        let finalImageUrl = urlInput.value.trim();
        
        // If they picked a file, upload it and override the URL box
        if (selectedImageFile) {
            const fileName = `${Math.random()}.${selectedImageFile.name.split('.').pop()}`;
            const { error: uploadError } = await supabaseClient.storage.from('product-images').upload(fileName, selectedImageFile);
            if (uploadError) { alert("Image upload failed: " + uploadError.message); cancelEdit(); btn.disabled = false; return; }
            finalImageUrl = supabaseClient.storage.from('product-images').getPublicUrl(fileName).data.publicUrl;
        }

        if (editingProductId) {
            const updates = { name: name, price: price, description: desc, category: cat, image_url: finalImageUrl };
            const { error } = await supabaseClient.from('products').update(updates).eq('id', editingProductId);
            if (error) { alert("Error updating product: " + error.message); } 
            else { alert("Product Updated Successfully!"); }
        } else {
            const { error } = await supabaseClient.from('products').insert([{ 
                name: name, price: price, description: desc, category: cat, status: 'Available', image_url: finalImageUrl 
            }]);
            if (error) { alert("Error adding product: " + error.message); } 
            else { alert("Product published!"); }
        }

        btn.disabled = false;
        cancelEdit(); 
        fetchProducts(); 
    }

    async function updateProdStatus(rawId) {
        const targetId = /^\d+$/.test(rawId) ? parseInt(rawId) : rawId;
        const newStatus = document.getElementById(`prod-status-${rawId}`).value;
        const { error } = await supabaseClient.from('products').update({ status: newStatus }).eq('id', targetId);
        if (error) alert("Error: " + error.message); else alert("Status updated!");
    }

    async function deleteProduct(rawId) {
        if(confirm("Are you sure you want to delete this item forever?")) {
            const targetId = /^\d+$/.test(rawId) ? parseInt(rawId) : rawId;
            const { error } = await supabaseClient.from('products').delete().eq('id', targetId);
            if (error) { alert("Vault Error!"); } else { fetchProducts(); }
        }
    }

    async function fetchAllTickets() {
        const container = document.getElementById('allTicketsContainer');
        const { data: tickets } = await supabaseClient.from('support_tickets').select('*').order('created_at', { ascending: false });
        if (!tickets || tickets.length === 0) { container.innerHTML = '<p style="color: #888;">No tickets in the queue!</p>'; return; }
        
        let html = '';
        tickets.forEach(ticket => {
            const date = new Date(ticket.created_at).toLocaleString();
            html += `<div class="ticket-card"><div class="ticket-header"><div><strong>User: ${ticket.user_email}</strong></div><div style="text-align: right; color: #666;">${date}<br><strong style="color: #d32f2f;">${ticket.issue_type}</strong></div></div><div class="ticket-text">${ticket.issue_details}</div></div>`;
        });
        container.innerHTML = html;
    }

    async function logOut() { await supabaseClient.auth.signOut(); window.location.replace('index.html'); }
    checkSecurity();
</script>
</body>
</html>
