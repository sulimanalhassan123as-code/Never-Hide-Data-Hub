<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Never Hide Data Hub - Admin Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #e3f2fd; color: #333; margin: 0; padding: 0; }
        .navbar { background-color: #0d47a1; color: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .navbar h1 { margin: 0; font-size: 18px; color: #90caf9; letter-spacing: 1px; text-transform: uppercase; }
        .logout-btn { background-color: #d32f2f; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .container { max-width: 800px; margin: 30px auto; padding: 30px; background: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .header-text { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        .ticket-card { background: #fff; padding: 15px; margin-bottom: 20px; border-left: 5px solid #0d47a1; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e0e0e0; }
        .product-card { background: #fff; padding: 15px; margin-bottom: 15px; border-left: 5px solid #ff9800; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .ticket-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid #eee; padding-bottom: 12px; margin-bottom: 12px; font-size: 14px; }
        .ticket-text { margin: 10px 0; font-size: 15px; color: #222; background: #f9f9f9; padding: 10px; border-radius: 4px; border: 1px solid #eee; }
        .admin-controls { display: flex; gap: 10px; margin-top: 15px; align-items: center; flex-wrap: wrap; width: 100%; }
        select, input[type="text"] { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; box-sizing: border-box; }
        input[type="text"] { flex-grow: 1; min-width: 200px; }
        .update-btn { background-color: #1976d2; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .update-btn:hover { background-color: #115293; }
        .add-btn { background-color: #ff9800; color: white; border: none; padding: 12px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 15px; font-size: 16px;}
        .delete-btn { background-color: #d32f2f; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .wa-btn { background-color: #25D366; color: white; text-decoration: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; font-weight: bold; display: inline-block; margin-top: 8px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        
        /* New Image Upload UI */
        .image-upload-box { background: #fff; padding: 10px; border: 1px dashed #ff9800; border-radius: 4px; text-align: center; grid-column: span 2; }
        .image-upload-box label { font-size: 13px; font-weight: bold; color: #e65100; display: block; margin-bottom: 5px; }
        
        @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } .image-upload-box { grid-column: span 1; } }
    </style>
</head>
<body>

<div class="navbar">
    <h1>Data Hub - BOSS DASHBOARD</h1>
    <button class="logout-btn" onclick="logOut()">Sign Out</button>
</div>

<div class="container" style="border-top: 5px solid #ff9800;">
    <div class="header-text">
        <h2 style="color: #e65100; margin-top: 0;">üì¶ Storefront Inventory</h2>
        <p style="color: #666; font-size: 14px; margin-bottom: 0;">Add new bundles, ECG services, or physical products with images.</p>
    </div>

    <div style="background: #fff8e1; padding: 20px; border-radius: 8px; border: 1px solid #ffecb3; margin-bottom: 30px;">
        <h3 style="margin-top: 0; color: #ff8f00;">Add New Product</h3>
        <div class="form-grid">
            <input type="text" id="newProdName" placeholder="Product Name (e.g. MTN 10GB)">
            <input type="text" id="newProdPrice" placeholder="Price (e.g. 100 GHS)">
            <input type="text" id="newProdDesc" placeholder="Description or Affiliate Link">
            <select id="newProdCat">
                <option value="mtn">MTN</option>
                <option value="telecel">Telecel</option>
                <option value="airteltigo">AirtelTigo</option>
                <option value="ecg">ECG Bill</option>
                <option value="ad">Physical Product / Ad</option>
            </select>
            
            <div class="image-upload-box">
                <label>üì∏ Product Image (Optional - Leave blank for Data Bundles)</label>
                <input type="file" id="newProdImage" accept="image/*" style="width: 100%;">
            </div>
        </div>
        <button class="add-btn" id="uploadBtn" onclick="addProduct()">Publish to Storefront</button>
    </div>

    <h3 style="color: #333;">Live Products</h3>
    <div id="allProductsContainer">
        <p style="color: #888; font-style: italic;">Loading inventory...</p>
    </div>
</div>

<div class="container">
    <div class="header-text">
        <h2>üõ†Ô∏è Master Support & Order Queue</h2>
    </div>
    <div id="allTicketsContainer">
        <p style="color: #888; font-style: italic;">Loading master database...</p>
    </div>
</div>

<script>
    const supabaseUrl = 'https://obyemhakouoipngwldsg.supabase.co';
    const supabaseKey = 'sb_publishable_oB_5NVgxwkwUucCECTzb2Q_1K0VqmyT';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
    
    // Your exact CEO email is locked in!
    const ADMIN_EMAIL = "ghanacyber2@gmail.com"; 

    async function checkSecurity() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session || session.user.email !== ADMIN_EMAIL) {
            alert("SECURITY ALERT: You do not have Boss clearance.");
            window.location.replace('index.html');
            return;
        }
        fetchProducts();
        fetchAllTickets();
    }

    async function fetchProducts() {
        const container = document.getElementById('allProductsContainer');
        const { data, error } = await supabaseClient.from('products').select('*').order('id', { ascending: false });

        if (error || !data) { container.innerHTML = '<p style="color: red;">Error loading inventory.</p>'; return; }
        if (data.length === 0) { container.innerHTML = '<p style="color: #888;">No products yet. Add your first bundle above!</p>'; return; }

        let html = '';
        data.forEach(prod => {
            // Show a tiny preview of the image if it exists
            let imgPreview = prod.image_url ? `<img src="${prod.image_url}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #ccc;">` : `<div style="width: 50px; height: 50px; background: #eee; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #999;">No Img</div>`;

            html += `
                <div class="product-card">
                    <div style="display: flex; gap: 15px; align-items: center; flex-grow: 1;">
                        ${imgPreview}
                        <div>
                            <strong>${prod.name}</strong> - <span style="color: #2e7d32; font-weight: bold;">${prod.price}</span><br>
                            <span style="font-size: 12px; color: #666; text-transform: uppercase;">Category: ${prod.category}</span>
                        </div>
                    </div>
                    <div class="admin-controls" style="width: auto; margin-top: 0;">
                        <select id="prod-status-${prod.id}">
                            <option value="Available" ${prod.status === 'Available' ? 'selected' : ''}>üü¢ Available</option>
                            <option value="Coming Soon" ${prod.status === 'Coming Soon' ? 'selected' : ''}>üü° Coming Soon</option>
                            <option value="Out of Stock" ${prod.status === 'Out of Stock' ? 'selected' : ''}>üî¥ Out of Stock</option>
                        </select>
                        <button class="update-btn" onclick="updateProdStatus('${prod.id}')">Update</button>
                        <button class="delete-btn" onclick="deleteProduct('${prod.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    async function addProduct() {
        const name = document.getElementById('newProdName').value;
        const price = document.getElementById('newProdPrice').value;
        const desc = document.getElementById('newProdDesc').value;
        const cat = document.getElementById('newProdCat').value;
        const imageFile = document.getElementById('newProdImage').files[0];

        if(!name || !price) { alert("Name and Price are required!"); return; }

        const btn = document.getElementById('uploadBtn');
        btn.innerText = "Uploading to Cloud...";
        btn.disabled = true;

        let finalImageUrl = ""; // Starts blank

        // IF THE BOSS UPLOADED AN IMAGE, PROCESS IT
        if (imageFile) {
            const fileExt = imageFile.name.split('.').pop();
            const fileName = `${Math.random()}.${fileExt}`;
            
            const { data: uploadData, error: uploadError } = await supabaseClient.storage
                .from('product-images')
                .upload(fileName, imageFile);

            if (uploadError) {
                alert("Image upload failed: " + uploadError.message);
                btn.innerText = "Publish to Storefront";
                btn.disabled = false;
                return;
            }

            // Get the public link to the picture
            const { data } = supabaseClient.storage.from('product-images').getPublicUrl(fileName);
            finalImageUrl = data.publicUrl;
        }

        // SAVE PRODUCT TO DATABASE
        const { error } = await supabaseClient.from('products').insert([{ 
            name: name, 
            price: price, 
            description: desc, 
            category: cat, 
            status: 'Available',
            image_url: finalImageUrl 
        }]);

        btn.innerText = "Publish to Storefront";
        btn.disabled = false;

        if (error) {
            alert("Error adding product: " + error.message);
        } else {
            document.getElementById('newProdName').value = '';
            document.getElementById('newProdPrice').value = '';
            document.getElementById('newProdDesc').value = '';
            document.getElementById('newProdImage').value = '';
            fetchProducts();
            alert("Product successfully pushed to Storefront!");
        }
    }

    async function updateProdStatus(id) {
        const newStatus = document.getElementById(`prod-status-${id}`).value;
        const { error } = await supabaseClient.from('products').update({ status: newStatus }).eq('id', id);
        if (error) alert("Error: " + error.message); else { alert("Status updated!"); fetchProducts(); }
    }

    async function deleteProduct(id) {
        if(confirm("Are you sure you want to delete this product forever?")) {
            const { error } = await supabaseClient.from('products').delete().eq('id', id);
            if (error) alert("Error: " + error.message); else fetchProducts();
        }
    }

    async function fetchAllTickets() {
        const container = document.getElementById('allTicketsContainer');
        const { data: tickets, error: tError } = await supabaseClient.from('support_tickets').select('*').order('created_at', { ascending: false });
        const { data: profiles, error: pError } = await supabaseClient.from('user_profiles').select('*');

        if (tError || !tickets) { container.innerHTML = '<p style="color: red;">Error loading tickets.</p>'; return; }
        if (tickets.length === 0) { container.innerHTML = '<p style="color: #888;">No tickets in the queue!</p>'; return; }

        const phoneBook = {};
        if (profiles) profiles.forEach(p => { phoneBook[p.user_email] = p.whatsapp_number; });

        let html = '';
        tickets.forEach(ticket => {
            const date = new Date(ticket.created_at).toLocaleString();
            const currentReply = ticket.admin_reply ? ticket.admin_reply : "";
            const userPhone = phoneBook[ticket.user_email];
            let waButton = "";
            if (userPhone) {
                let cleanNum = userPhone.replace(/\s+/g, '');
                if (cleanNum.startsWith('0')) cleanNum = '233' + cleanNum.substring(1);
                else if (!cleanNum.startsWith('233') && !cleanNum.startsWith('+')) cleanNum = '233' + cleanNum;
                cleanNum = cleanNum.replace('+', '');
                const waMessage = encodeURIComponent(`Hello! This is the Admin of Never Hide Data Hub. Re: ${ticket.issue_type}`);
                waButton = `<a href="https://wa.me/${cleanNum}?text=${waMessage}" target="_blank" class="wa-btn">üí¨ Chat on WhatsApp</a>`;
            }

            html += `
                <div class="ticket-card" id="ticket-${ticket.id}">
                    <div class="ticket-header">
                        <div><strong>User: ${ticket.user_email}</strong><br>${waButton}</div>
                        <div style="text-align: right; color: #666;">${date}<br><strong style="color: #d32f2f;">${ticket.issue_type}</strong></div>
                    </div>
                    <div class="ticket-text">${ticket.issue_details}</div>
                    <div class="admin-controls">
                        <select id="status-${ticket.id}">
                            <option value="Pending" ${ticket.status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Reviewed" ${ticket.status === 'Reviewed' ? 'selected' : ''}>Reviewed</option>
                            <option value="Resolved" ${ticket.status === 'Resolved' ? 'selected' : ''}>Resolved</option>
                        </select>
                        <input type="text" id="reply-${ticket.id}" placeholder="Type your reply..." value="${currentReply}">
                        <button class="update-btn" onclick="updateTicket('${ticket.id}')">Save</button>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    async function updateTicket(ticketId) {
        const newStatus = document.getElementById(`status-${ticketId}`).value;
        const newReply = document.getElementById(`reply-${ticketId}`).value;
        const { error } = await supabaseClient.from('support_tickets').update({ status: newStatus, admin_reply: newReply }).eq('id', ticketId);
        if (error) alert("Error: " + error.message); else { alert("Updated successfully!"); fetchAllTickets(); }
    }

    async function logOut() {
        await supabaseClient.auth.signOut();
        window.location.replace('index.html');
    }

    checkSecurity();
</script>

</body>
</html>
